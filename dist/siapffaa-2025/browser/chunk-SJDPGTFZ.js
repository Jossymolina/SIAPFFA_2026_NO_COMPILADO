import{a as G,b as K}from"./chunk-CNAZPYPR.js";import"./chunk-CYBTF2RE.js";import"./chunk-W7TJHXMM.js";import{l as Y}from"./chunk-EQMPRG6V.js";import"./chunk-36JN3LZY.js";import"./chunk-M763EXIE.js";import"./chunk-QE2BREUU.js";import"./chunk-JPTHL2WT.js";import"./chunk-VAG7FTYF.js";import{A as B,B as v,C as W,d as $,e as H,l as w,s as A,z as U}from"./chunk-FIATBDAH.js";import{Bb as M,Ca as l,Cb as R,Db as I,Gb as F,Jb as Q,Lb as m,Mb as L,Na as S,Nb as x,Ob as V,Qb as X,Rb as z,Sa as y,Sb as P,U as g,V as b,Wb as O,Ya as _,aa as q,ea as j,ib as p,jb as c,kb as a,lb as E,mc as C,sb as D,wb as h,xb as f,ya as N}from"./chunk-XJSKPFVT.js";import"./chunk-OXVY4BEJ.js";function ee(i,s){if(i&1&&(c(0,"div",7),m(1),a()),i&2){let d=f();l(),V(" Filas: ",d.rows.length," | Columnas: ",d.columns.length," ")}}function te(i,s){if(i&1&&(c(0,"div",8),m(1),a()),i&2){let d=f();l(),x(" ",d.message," ")}}function ne(i,s){if(i&1&&(c(0,"th"),m(1),a()),i&2){let d=s.$implicit;l(),L(d)}}function ie(i,s){if(i&1&&(c(0,"td"),m(1),a()),i&2){let d=s.$implicit,t=f().$implicit,e=f(2);l(),L(e.formatCell(t[d]))}}function oe(i,s){if(i&1&&(c(0,"tr"),_(1,ie,2,1,"td",11),a()),i&2){let d=f(2);l(),p("ngForOf",d.columns)}}function re(i,s){if(i&1&&(c(0,"div",9)(1,"table",10)(2,"thead")(3,"tr"),_(4,ne,2,1,"th",11),a()(),c(5,"tbody"),_(6,oe,2,1,"tr",11),a()()()),i&2){let d=f();l(4),p("ngForOf",d.columns),l(2),p("ngForOf",d.rows)}}var J=(()=>{let s=class s{constructor(){this.response=null,this.rows=[],this.columns=[],this.message=""}ngOnChanges(){if(this.rows=[],this.columns=[],this.message="",!!this.response){if(Array.isArray(this.response.resultado)){this.rows=this.response.resultado,this.columns=this.buildColumns(this.rows),this.rows.length===0&&(this.message=this.response.mensaje??"No hay datos");return}this.message=this.response.mensaje??this.response.error??"Respuesta sin datos"}}buildColumns(t){let e=[],n=new Set;for(let o of t)for(let r of Object.keys(o))n.has(r)||(n.add(r),e.push(r));return e}formatCell(t){return t==null?"":typeof t=="object"?JSON.stringify(t):String(t)}exportarExcel(){if(!this.rows.length)return;let t=this.rows.map(o=>{let r={};for(let u of this.columns)r[u]=o[u]??"";return r}),e=v.json_to_sheet(t,{header:this.columns}),n=v.book_new();v.book_append_sheet(n,e,"Resultado"),B(n,`resultado_sql_${this.stamp()}.xlsx`)}exportarCSV(){if(!this.rows.length)return;let t=this.rows.map(u=>{let T={};for(let k of this.columns)T[k]=u[k]??"";return T}),e=v.json_to_sheet(t,{header:this.columns}),n=v.sheet_to_csv(e),o=new Blob([n],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download=`resultado_sql_${this.stamp()}.csv`,r.click(),URL.revokeObjectURL(r.href)}stamp(){let t=new Date,e=n=>String(n).padStart(2,"0");return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())}_${e(t.getHours())}${e(t.getMinutes())}${e(t.getSeconds())}`}};s.\u0275fac=function(e){return new(e||s)},s.\u0275cmp=y({type:s,selectors:[["app-resultado-query"]],inputs:{response:"response"},features:[j],decls:9,vars:5,consts:[[1,"card","p-3"],[1,"d-flex","gap-2","align-items-center","mb-2"],[1,"btn","btn-success","btn-sm",3,"click","disabled"],[1,"btn","btn-outline-secondary","btn-sm",3,"click","disabled"],["class","ms-auto small text-muted",4,"ngIf"],["class","alert alert-info py-2 mb-0",4,"ngIf"],["class","table-responsive",4,"ngIf"],[1,"ms-auto","small","text-muted"],[1,"alert","alert-info","py-2","mb-0"],[1,"table-responsive"],[1,"table","table-striped","table-bordered","table-sm","align-middle"],[4,"ngFor","ngForOf"]],template:function(e,n){e&1&&(c(0,"div",0)(1,"div",1)(2,"button",2),h("click",function(){return n.exportarExcel()}),m(3," Exportar Excel "),a(),c(4,"button",3),h("click",function(){return n.exportarCSV()}),m(5," Exportar CSV "),a(),_(6,ee,2,2,"div",4),a(),_(7,te,2,1,"div",5)(8,re,7,2,"div",6),a()),e&2&&(l(2),p("disabled",n.rows.length===0),l(2),p("disabled",n.rows.length===0),l(2),p("ngIf",n.rows.length),l(),p("ngIf",n.message&&n.rows.length===0),l(),p("ngIf",n.rows.length))},dependencies:[w,$,H],encapsulation:2});let i=s;return i})();var se=["ta"],ae=["pre"],le=()=>({width:"95vw",height:"90vh"}),ce=()=>({height:"calc(90vh - 60px)",overflow:"auto"}),Ee=(()=>{let s=class s{constructor(t,e,n){this.sanitizer=t,this._ServicioBackendService=e,this._servicioMensaje=n,this.sql=q("----"),this.KEYWORDS=["SELECT","FROM","WHERE","AND","OR","NOT","IN","IS","NULL","LIKE","BETWEEN","JOIN","INNER","LEFT","RIGHT","FULL","OUTER","ON","GROUP","BY","HAVING","ORDER","ASC","DESC","LIMIT","OFFSET","DISTINCT","AS","UNION","ALL","WITH","EXPLAIN","SHOW","DESCRIBE","DESC"],this.chars=C(()=>this.sql().length),this.lines=C(()=>(this.sql().match(/\n/g)?.length??0)+1),this.highlighted=C(()=>{let o=this.highlight(this.sql());return this.sanitizer.bypassSecurityTrustHtml(o)}),this.visible=!1}onInput(t){this.sql.set(t),queueMicrotask(()=>this.syncScroll())}onScroll(){this.syncScroll()}copiar(){navigator.clipboard?.writeText(this.sql())}capturarTexto(){let t=this.sql().trim();this._servicioMensaje.show("Ejecutando consulta SQL..."),this._ServicioBackendService.ejecutarSqlSoloLectura({sql:t}).subscribe({next:e=>{this._servicioMensaje.hide(),this.resultadoConsulta=e,this.abrirResultado()},error:e=>{this._servicioMensaje.hide()}})}limpiar(){this.sql.set(""),queueMicrotask(()=>this.syncScroll()),this.taRef.nativeElement.focus()}syncScroll(){let t=this.taRef.nativeElement,e=this.preRef.nativeElement;e.scrollTop=t.scrollTop,e.scrollLeft=t.scrollLeft}escapeHtml(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}highlight(t){let e=this.escapeHtml(t);if(!e.trim())return'<span style="color:#9ca3af !important;">Escribe tu SQL aqu\xED\u2026</span>';e=e.replace(/--.*$/gm,r=>`<span style="color:#9ca3af !important;font-style:italic !important;">${r}</span>`),e=e.replace(/'(?:\\'|[^'])*'/g,r=>`<span style="color:#16a34a !important;">${r}</span>`);let n=this.KEYWORDS.join("|"),o=new RegExp(`\\b(${n})\\b`,"gi");return e=e.replace(o,r=>`<span style="color:#2563eb !important;font-weight:700 !important;">${r.toUpperCase()}</span>`),e}abrirResultado(){this.visible=!0}};s.\u0275fac=function(e){return new(e||s)(S(A),S(W),S(U))},s.\u0275cmp=y({type:s,selectors:[["app-consultas-sql"]],viewQuery:function(e,n){if(e&1&&(M(se,7),M(ae,7)),e&2){let o;R(o=I())&&(n.taRef=o.first),R(o=I())&&(n.preRef=o.first)}},decls:24,vars:16,consts:[["pre",""],["ta",""],[1,"card"],[1,"top"],[1,"muted"],[1,"btns"],["type","button",1,"btn",3,"click"],["type","button",1,"btn","btn-ghost",3,"click"],[1,"editor-wrap"],[1,"hl",3,"innerHTML"],["spellcheck","false",1,"ta","p-inputtextarea","p-inputtext",3,"input","scroll","value"],[1,"meta"],["header","Resultado de la consulta",3,"visibleChange","visible","modal","draggable","resizable","maximizable","contentStyle","baseZIndex"],[3,"response"]],template:function(e,n){if(e&1){let o=D();c(0,"div",2)(1,"div",3)(2,"div")(3,"h2"),m(4,"SQL Editor"),a(),c(5,"p",4),m(6,"Las palabras clave se resaltan en azul."),a()(),c(7,"div",5)(8,"button",6),h("click",function(){return g(o),b(n.capturarTexto())}),m(9,"Consultar"),a(),c(10,"button",7),h("click",function(){return g(o),b(n.limpiar())}),m(11,"Limpiar"),a()()(),c(12,"div",8),E(13,"pre",9,0),c(15,"textarea",10,1),h("input",function(){g(o);let u=F(16);return b(n.onInput(u.value))})("scroll",function(){return g(o),b(n.onScroll())}),a()(),c(17,"div",11)(18,"span",4),m(19),a(),c(20,"span",4),m(21),a()()(),c(22,"p-dialog",12),P("visibleChange",function(u){return g(o),z(n.visible,u)||(n.visible=u),b(u)}),E(23,"app-resultado-query",13),a()}e&2&&(l(13),p("innerHTML",n.highlighted(),N),l(2),p("value",n.sql()),l(4),x("",n.chars()," caracteres"),l(2),x("",n.lines()," l\xEDneas"),l(),Q(O(14,le)),X("visible",n.visible),p("modal",!0)("draggable",!1)("resizable",!0)("maximizable",!0)("contentStyle",O(15,ce))("baseZIndex",1e4),l(),p("response",n.resultadoConsulta))},dependencies:[w,J,K,G,Y],styles:[".card[_ngcontent-%COMP%]{max-width:1100px;margin:16px auto;padding:16px;border:1px solid #e7e7e7;border-radius:14px;background:#fff}.top[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:12px}h2[_ngcontent-%COMP%]{margin:0}.muted[_ngcontent-%COMP%]{color:#6b7280;margin:6px 0 0}.btns[_ngcontent-%COMP%]{display:flex;gap:10px}.btn[_ngcontent-%COMP%]{border:1px solid #d1d5db;border-radius:12px;padding:10px 12px;cursor:pointer;background:#fff}.btn-ghost[_ngcontent-%COMP%]{background:transparent}.editor-wrap[_ngcontent-%COMP%]{position:relative;margin-top:14px;height:280px;border:1px solid #d7d7d7;border-radius:12px;overflow:hidden;background:#fff}.hl[_ngcontent-%COMP%]{position:absolute;inset:0;margin:0;padding:12px;overflow:auto;white-space:pre;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace;font-size:14px;line-height:1.45;z-index:1;pointer-events:none}.ta[_ngcontent-%COMP%]{position:absolute;inset:0;margin:0;padding:12px;border:0!important;outline:none!important;resize:none!important;background:transparent!important;background-color:transparent!important;color:transparent!important;-webkit-text-fill-color:transparent!important;caret-color:#111827!important;overflow:auto!important;white-space:pre!important;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace!important;font-size:14px!important;line-height:1.45!important;z-index:2!important}.meta[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:12px;margin-top:10px}"]});let i=s;return i})();export{Ee as ConsultasSqlComponent};
